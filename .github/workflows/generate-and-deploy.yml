name: Parse Dynamic YAML

on:
  workflow_dispatch:
    inputs:
      resource:
        description: 'Recurso a procesar (e.g., recurso1)'
        required: true

jobs:
  generate-and-run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
      - name: Generate and parse YAML
        run: |
          # Generar YAML
          cat <<EOF > dynamic.yml
          jobs:
            process-${{ github.event.inputs.resource }}:
              steps:
                - run: echo "Processing ${{ github.event.inputs.resource }}"
                - run: cd resources/${{ github.event.inputs.resource }} && bash ./deploy.sh
          EOF
          # Parsear y ejecutar comandos
          COMMANDS=$(yq e '.jobs.*.steps[].run' dynamic.yml)
          while IFS= read -r cmd; do
            echo "Ejecutando: $cmd"
            eval "$cmd"
          done <<< "$COMMANDS"